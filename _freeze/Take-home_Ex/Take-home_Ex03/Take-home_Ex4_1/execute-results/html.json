{
  "hash": "f7717a0a174ca856cb2167593dc82270",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Take-home_Ex03\"\nauthor: \"Yuheng Liang\"\nformat: html\neditor: visual\ndate: \"Oct 28, 2024\"\ndate-modified: \"Oct 28, 2024\"\nexecute: \n  eval: true\n  echo: true\n  freeze: true\n---\n\n\n#Take-home_Ex03\n\n## package\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, raster, spatstat, tmap, tidyverse,sparr,spNetwork,dplyr,animation,stringr)\n```\n:::\n\n\n## data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug_case <- read_csv(\"data/2016-01-01-2024-06-30-Philippines.csv\")%>%\n    st_as_sf(coords = c(\"longitude\", \"latitude\"), crs = 4326) %>%\n    st_transform(crs = 32651) %>%\n  mutate(event_date = dmy(event_date)) %>%\n  mutate(event_month = year*100 + month(event_date)) %>%\n  mutate(event_quarter = year*10 + quarter(event_date))%>%\n  mutate(quarter = as.numeric(str_sub(event_quarter, 5, 5)))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 6921 Columns: 31\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (23): event_id_cnty, event_date, disorder_type, event_type, sub_event_ty...\ndbl  (8): year, time_precision, iso, latitude, longitude, geo_precision, fat...\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(drug_case,\"data/drug_case.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 按省份和年份分组并统计案例数量\nsummary_data <- drug_case %>%\n  group_by(admin2, year) %>%\n  summarise(total_cases = n(), .groups = \"drop\") # 统计每组的行数\n\n# 查看结果\nprint(summary_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 435 features and 3 fields\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: -128531.7 ymin: 518340.4 xmax: 864960.5 ymax: 2055587\nProjected CRS: WGS 84 / UTM zone 51N\n# A tibble: 435 × 4\n   admin2            year total_cases                                   geometry\n   <chr>            <dbl>       <int>                             <GEOMETRY [m]>\n 1 Abra              2016           6 MULTIPOINT ((243552.1 1949406), (247247.5…\n 2 Abra              2017           2 MULTIPOINT ((246789.8 1947649), (259088.9…\n 3 Abra              2019           1                   POINT (248189.3 1945782)\n 4 Abra              2020           1                   POINT (249952.6 1952636)\n 5 Abra              2024           2 MULTIPOINT ((246603.5 1948039), (248189.3…\n 6 Agusan del Norte  2016          17 MULTIPOINT ((754728.1 990125.8), (757148.…\n 7 Agusan del Norte  2017           1                  POINT (779704.2 990191.1)\n 8 Agusan del Norte  2021           1                  POINT (779704.2 990191.1)\n 9 Agusan del Norte  2022           2                  POINT (779704.2 990191.1)\n10 Agusan del Norte  2024           1                  POINT (779704.2 990191.1)\n# ℹ 425 more rows\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nph_sf = st_read(dsn = \"data/phl_adm_psa_namria_20231106_shp\",layer = \"phl_admbnda_adm2_psa_namria_20231106\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `phl_admbnda_adm2_psa_namria_20231106' from data source \n  `/Users/liangyuhang/Downloads/Maaaaaaaaaark/IS415_g/Take-home_Ex/Take-home_Ex03/data/phl_adm_psa_namria_20231106_shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 88 features and 13 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 114.2779 ymin: 4.587294 xmax: 126.605 ymax: 21.12189\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n\n## 1st Order Spatial Point Patterns Analysis Methods（take 2016 whole year Manila as example）\n\n### filte the data and year\n\n\n::: {.cell}\n\n```{.r .cell-code}\nManila_sf = ph_sf %>% filter(str_detect(ADM2_EN, \"^Metropolitan Manila\"))\nBulacan_sf = ph_sf %>% filter(str_detect(ADM2_EN,\"^Bulacan\"))\nCebu_sf = ph_sf %>% filter(str_detect(ADM2_EN, \"^Cebu\"))\nLaguna_sf = ph_sf %>% filter(str_detect(ADM2_EN, \"^Laguna\"))\nPangasinan_sf = ph_sf %>% filter(str_detect(ADM2_EN, \"^Pangasinan\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug_case_2016 <- drug_case%>%\n  filter(year== 2016)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug_Manila_2016 = drug_case_2016 %>% filter(str_detect(admin2, \"^Metropolitan Manila\"))\n```\n:::\n\n\n### Converting sf data frames to sp’s Spatial\\* class\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug_Manila_2016_sf <- as_Spatial(drug_Manila_2016)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug_Manila_2016\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 783 features and 32 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 279767.7 ymin: 1593737 xmax: 296805.5 ymax: 1623566\nProjected CRS: WGS 84 / UTM zone 51N\n# A tibble: 783 × 33\n   event_id_cnty event_date  year time_precision disorder_type      event_type  \n * <chr>         <date>     <dbl>          <dbl> <chr>              <chr>       \n 1 PHL6636       2016-12-30  2016              1 Political violence Violence ag…\n 2 PHL6635       2016-12-29  2016              1 Political violence Violence ag…\n 3 PHL6634       2016-12-28  2016              1 Political violence Violence ag…\n 4 PHL2095       2016-12-28  2016              1 Political violence Violence ag…\n 5 PHL2089       2016-12-27  2016              1 Political violence Violence ag…\n 6 PHL6631       2016-12-26  2016              1 Political violence Violence ag…\n 7 PHL2085       2016-12-26  2016              1 Political violence Violence ag…\n 8 PHL6628       2016-12-22  2016              1 Political violence Violence ag…\n 9 PHL6627       2016-12-22  2016              1 Political violence Violence ag…\n10 PHL2068       2016-12-21  2016              1 Political violence Violence ag…\n# ℹ 773 more rows\n# ℹ 27 more variables: sub_event_type <chr>, actor1 <chr>, assoc_actor_1 <chr>,\n#   inter1 <chr>, actor2 <chr>, assoc_actor_2 <chr>, inter2 <chr>,\n#   interaction <chr>, civilian_targeting <chr>, iso <dbl>, region <chr>,\n#   country <chr>, admin1 <chr>, admin2 <chr>, admin3 <chr>, location <chr>,\n#   geo_precision <dbl>, source <chr>, source_scale <chr>, notes <chr>,\n#   fatalities <dbl>, tags <chr>, timestamp <dbl>, geometry <POINT [m]>, …\n```\n\n\n:::\n:::\n\n\n### Converting the Spatial\\* class into generic sp format\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug_Manila_2016_ppp <- as.ppp(drug_Manila_2016)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in as.ppp.sf(drug_Manila_2016): only first attribute column is used for\nmarks\n```\n\n\n:::\n\n```{.r .cell-code}\ndrug_Manila_2016_ppp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern: 783 points\nmarks are of storage type  'character'\nwindow: rectangle = [279767.7, 296805.51] x [1593737.4, 1623565.7] units\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(drug_Manila_2016_ppp)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in default.charmap(ntypes, chars): Too many types to display every type\nas a different character\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Only 10 out of 783 symbols are shown in the symbol map\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### Creating owin object\n\n\n::: {.cell}\n\n```{.r .cell-code}\nManila_sf = st_transform(Manila_sf,crs = 32651)\nBulacan_sf = st_transform(Bulacan_sf,crs = 32651)\nPangasinan_sf = st_transform(Pangasinan_sf,crs = 32651)\nCebu_sf = st_transform(Cebu_sf,crs = 32651)\nLaguna_sf = st_transform(Laguna_sf,crs = 32651)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nManila_owin <- as.owin(Manila_sf)\nBulacan_owin <- as.owin(Bulacan_sf)\nPangasinan_owin <- as.owin(Pangasinan_sf)\nCebu_owin <- as.owin(Cebu_sf)\nLaguna_owin <- as.owin(Laguna_sf)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(Manila_owin,\"data/owin/Manila_owin.rds\")\nwrite_rds(Bulacan_owin,\"data/owin/Bulacan_owin.rds\")\nwrite_rds(Pangasinan_owin,\"data/owin/Pangasinan_owin.rds\")\nwrite_rds(Cebu_owin,\"data/owin/Cebu_owin.rds\")\nwrite_rds(Laguna_owin,\"data/owin/Laguna_owin.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(Manila_owin)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n### Combining point events object and owin object\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrugManila_ppp = drug_Manila_2016_ppp[Manila_owin]\n```\n:::\n\n\n### First-order Spatial Point Patterns Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkde_childcareSG_bw <- density(drugManila_ppp,\n                              sigma=bw.diggle,\n                              edge=TRUE,\n                            kernel=\"gaussian\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(kde_childcareSG_bw)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndrugManila_ppp.km <- rescale.ppp(drugManila_ppp, 1000, \"km\")\n```\n:::\n\n\n### Working with different automatic badwidth methods\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkde_drugManila.ppl <- density(drugManila_ppp.km, \n                               sigma=bw.ppl, \n                               edge=TRUE,\n                               kernel=\"gaussian\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Likelihood Cross-Validation criterion was maximised at left-hand end\nof interval [0.807, 24.4]; use argument 'srange' to specify a wider interval\nfor bandwidth 'sigma'\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(kde_drugManila.ppl, main = \"bw.ppl\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n### working with different method\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(2,2))\nplot(density(drugManila_ppp.km, \n             sigma=bw.ppl, \n             edge=TRUE, \n             kernel=\"gaussian\"), \n     main=\"Gaussian\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Likelihood Cross-Validation criterion was maximised at left-hand end\nof interval [0.807, 24.4]; use argument 'srange' to specify a wider interval\nfor bandwidth 'sigma'\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(density(drugManila_ppp.km, \n             sigma=bw.ppl, \n             edge=TRUE, \n             kernel=\"epanechnikov\"), \n     main=\"Epanechnikov\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in density.ppp(drugManila_ppp.km, sigma = bw.ppl, edge = TRUE, kernel =\n\"epanechnikov\"): Bandwidth selection will be based on Gaussian kernel\nWarning in density.ppp(drugManila_ppp.km, sigma = bw.ppl, edge = TRUE, kernel =\n\"epanechnikov\"): Likelihood Cross-Validation criterion was maximised at\nleft-hand end of interval [0.807, 24.4]; use argument 'srange' to specify a\nwider interval for bandwidth 'sigma'\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(density(drugManila_ppp.km, \n             sigma=bw.ppl, \n             edge=TRUE, \n             kernel=\"quartic\"), \n     main=\"Quartic\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in density.ppp(drugManila_ppp.km, sigma = bw.ppl, edge = TRUE, kernel =\n\"quartic\"): Bandwidth selection will be based on Gaussian kernel\nWarning in density.ppp(drugManila_ppp.km, sigma = bw.ppl, edge = TRUE, kernel =\n\"quartic\"): Likelihood Cross-Validation criterion was maximised at left-hand\nend of interval [0.807, 24.4]; use argument 'srange' to specify a wider\ninterval for bandwidth 'sigma'\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(density(drugManila_ppp.km, \n             sigma=bw.ppl, \n             edge=TRUE, \n             kernel=\"disc\"), \n     main=\"Disc\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in density.ppp(drugManila_ppp.km, sigma = bw.ppl, edge = TRUE, kernel =\n\"disc\"): Bandwidth selection will be based on Gaussian kernel\nWarning in density.ppp(drugManila_ppp.km, sigma = bw.ppl, edge = TRUE, kernel =\n\"disc\"): Likelihood Cross-Validation criterion was maximised at left-hand end\nof interval [0.807, 24.4]; use argument 'srange' to specify a wider interval\nfor bandwidth 'sigma'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n## 2nd Order Spatial Point Patterns Analysis Methods\n\n### G-function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nG_CK = Gest(drugManila_ppp, correction = \"border\")\nplot(G_CK, xlim=c(0,5))\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nG_CK.csr <- envelope(drugManila_ppp, Gest, nsim = 999)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGenerating 999 simulations of CSR  ...\n1, 2, 3, ......10.........20.........30.........40.........50.........60..\n.......70.........80.........90.........100.........110.........120.........130\n.........140.........150.........160.........170.........180.........190........\n.200.........210.........220.........230.........240.........250.........260......\n...270.........280.........290.........300.........310.........320.........330....\n.....340.........350.........360.........370.........380.........390.........400..\n.......410.........420.........430.........440.........450.........460.........470\n.........480.........490.........500.........510.........520.........530........\n.540.........550.........560.........570.........580.........590.........600......\n...610.........620.........630.........640.........650.........660.........670....\n.....680.........690.........700.........710.........720.........730.........740..\n.......750.........760.........770.........780.........790.........800.........810\n.........820.........830.........840.........850.........860.........870........\n.880.........890.........900.........910.........920.........930.........940......\n...950.........960.........970.........980.........990........\n999.\n\nDone.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(G_CK.csr, xlim=c(0,5))\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n### L-function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nF_CK.csr <- envelope(drugManila_ppp, Lest, nsim = 9)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGenerating 9 simulations of CSR  ...\n1, 2,  [2:53 remaining] 3,\n [2:29 remaining] 4,  [2:07 remaining] 5,  [1:41 remaining] 6,\n [1:15 remaining] 7,  [50 sec remaining] 8,  [25 sec remaining] \n9.\n\nDone.\n```\n\n\n:::\n\n```{.r .cell-code}\nL_ck.csr <- envelope(drugManila_ppp, Lest, nsim = 9, rank = 1, glocal=TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGenerating 9 simulations of CSR  ...\n1, 2,  [3:08 remaining] 3,\n [2:50 remaining] 4,  [2:20 remaining] 5,  [1:54 remaining] 6,\n [1:25 remaining] 7,  [56 sec remaining] 8,  [28 sec remaining] \n9.\n\nDone.\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite_rds \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nfunction (x, file, compress = c(\"none\", \"gz\", \"bz2\", \"xz\"), version = 2, \n    refhook = NULL, text = FALSE, path = deprecated(), ...) \n{\n    if (is_present(path)) {\n        deprecate_warn(\"1.4.0\", \"write_rds(path = )\", \"write_rds(file = )\")\n        file <- path\n    }\n    compress <- match.arg(compress)\n    con <- switch(compress, none = file(file, ...), gz = gzfile(file, \n        ...), bz2 = bzfile(file, ...), xz = xzfile(file, ...))\n    on.exit(close(con), add = TRUE)\n    saveRDS(x, con, version = version, refhook = refhook, ascii = text)\n    invisible(x)\n}\n<bytecode: 0x160e36750>\n<environment: namespace:readr>\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(F_CK.csr)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex4_1_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n### K-function\n\n::: {.cell}\n\n```{.r .cell-code}\nG_CK.csr <- envelope(drugManila_ppp, Gest, nsim = 999)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGenerating 999 simulations of CSR  ...\n1, 2, 3, ......10.........20.........30.........40.........50.........60..\n.......70.........80.........90.........100.........110.........120.........130\n.........140.........150.........160.........170.........180.........190........\n.200.........210.........220.........230.........240.........250.........260......\n...270.........280.........290.........300.........310.........320.........330....\n.....340.........350.........360.........370.........380.........390.........400..\n.......410.........420.........430.........440.........450.........460.........470\n.........480.........490.........500.........510.........520.........530........\n.540.........550.........560.........570.........580.........590.........600......\n...610.........620.........630.........640.........650.........660.........670....\n.....680.........690.........700.........710.........720.........730.........740..\n.......750.........760.........770.........780.........790.........800.........810\n.........820.........830.........840.........850.........860.........870........\n.880.........890.........900.........910.........920.........930.........940......\n...950.........960.........970.........980.........990........\n999.\n\nDone.\n```\n\n\n:::\n:::\n\n\n\n## ShinyApp Storyboard\n\nIn my part, I did three main things to analyze the case of drugs according to chronological order, 1st Order Spatial Point Patterns Analysis Methods and Spatio-Temporal Point Pattern Analysis \n\n### GeoVisualisation \nIn this section, the first thing I did was GeoVisualisation, and on shiny I set it up so that I could freely adjust the different dates according to the year and different months, making it easy for users to compare and view.\n\n### Time Series Analysis\n\nIn the Time Series Analysis module, the user can choose to view a quarterly or monthly histogram of the number of cases in the drop-down menu. Currently the Histogram tab shows the Annual Case Frequency Histogram, click on the Time Series Plot to view specific tabs according to the user's needs.\n\n### 1st Order Spatial Point Patterns Analysis Methods\n\n-   This page shows the “First-order Analysis” module in the user's Shiny application, which is used to analyze drug abuse data in the Philippines for the period 2016-2024. On the left side of the page, there are two checkboxes for selecting the year,area and function of the analysis, and a “Run First-order Analysis” button for performing the analysis.\n\n-   The graph on the right shows the results of the analysis, presented as a density map generated by Kernel Density Estimation (KDE), showing the spatial density distribution of drug abuse incidents in different regions. The color gradient from blue to yellow indicates the level of density, with the closer the color is to yellow the higher the density. This map helps to identify geographically high incidence areas of drug abuse incidents.\n\n-   By selecting different years and quarters, users can analyze the data spatially and temporally to observe the changes in the spatial distribution of drug abuse incidents over a specific time period.\n\n### Spatio-Temporal Point Pattern Analysis\n\nThe Second-order Analysis page allows you to select a year,area and function, and you can choose a specific time period to analyze in order to target a certain period of drug abuse. Meanwhile, the page provides different analysis functions, such as the G function, so that you can choose the appropriate function to analyze according to the purpose of the study. Click on the “Run Second-order Analysis” button to start the selected analysis.(The images below are not yet counted to show the corresponding images)\n",
    "supporting": [
      "Take-home_Ex4_1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}